<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f1115" />
  <title>TurboSign — Mobile Viewer</title>
  <style>
    :root{
      --bg:#0b0c10;--fg:#e8eaed;--muted:#aab2c0;--accent:#4da3ff;--bar:#0f1115;--border:#1b1e24
    }
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* Layout: compact top bar on mobile, persistent on desktop */
    .app{display:grid;grid-template-rows:52px 1fr;height:100dvh}
    .topbar{display:flex;align-items:center;gap:8px;padding:0 8px;background:var(--bar);border-bottom:1px solid var(--border)}
    .brand{font-weight:600}
    .spacer{flex:1}
    .btn,.file{background:#1a1d24;color:var(--fg);border:1px solid #2a2f39;padding:8px 10px;border-radius:10px;font:inherit}
    .btn{cursor:pointer}

    /* Main area */
    .main{position:relative}
    iframe{position:absolute;inset:0;border:0;width:100%;height:100%}

    /* Bottom mobile actions */
    .dock{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;justify-content:center;padding:10px;z-index:5}
    .dock .btn{background:var(--accent);color:#001022;border:0;font-weight:700}

    @media(min-width:900px){
      .app{grid-template-rows:56px 1fr}
      .dock{display:none}
    }
  </style>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    /* Signature modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:10000} .modal.open{display:grid} body.modal-open{overflow:hidden}
    .modal.open{display:grid}
    .sheet{width:min(92vw,900px);max-height:min(88vh,900px);display:grid;grid-template-rows:auto 1fr auto;background:#0f1115;border:1px solid #263041;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.6)}
    .sheet header{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid #1b1e24}
    .sheet header h3{margin:0;font-size:16px}
    .sheet main{display:grid;gap:12px;padding:12px;overflow:auto}
    .sig-row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .pad{background:#11161e;border:1px dashed #334; border-radius:12px; height:260px; position:relative}
    .pad canvas{width:100%;height:100%;display:block;border-radius:12px}
    .tools{display:flex;flex-wrap:wrap;gap:8px}
    .tools .btn{background:#1a1d24;color:#e8eaed;border:1px solid #2a2f39;padding:8px 10px;border-radius:10px;cursor:pointer}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .thumb{background:#141922;border:1px solid #2a2f39;border-radius:10px;padding:6px;display:grid;gap:6px;cursor:pointer}
    .thumb.selected{outline:2px solid #4da3ff}
    .thumb img{width:100%;height:90px;object-fit:contain;background:#0b0c10;border-radius:6px}
    .sheet footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid #1b1e24}
    .danger{border-color:#6b2c2c;background:#2a1414}
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">TurboSign</div>
      <div class="spacer"></div>
      <input id="file" class="file" type="file" accept="application/pdf" />
      <button id="fit" class="btn" aria-label="Fit width">Fit</button>
      <button id="thumbs" class="btn" aria-label="Thumbnails">Thumbs</button>
      <button id="sign" class="btn" aria-label="Open signature modal">Sign</button>
      <button id="place" class="btn" aria-label="Place signature">Place</button>
      <button id="export" class="btn" aria-label="Export signed PDF">Export</button>
    </header>
    <main class="main">
      <!-- IMPORTANT: host pdf.js dist under /pdfjs for same-origin control -->
      <iframe id="viewer" src="/web/viewer.html#zoom=page-width"></iframe>
      <!-- Mobile quick actions -->
      <div class="dock">
        <button id="mPrev" class="btn">Prev</button>
        <button id="mNext" class="btn">Next</button>
        <button id=\"mDl\" class=\"btn\">Download<\/button>
        <button id=\"mPlace\" class=\"btn\">Place<\/button>
      <\/div>
    </main>
  </div>

  <script>
    // Same-origin control helpers (no edits to viewer files required)
    /* reuse existing frame ref from earlier script */
    const ready = new Promise(resolve => {
      const poll = () => {
        try{ const a = frame.contentWindow?.PDFViewerApplication; if(a && a.initializedPromise){a.initializedPromise.then(()=>resolve(a)); return;} }catch(e){}
        setTimeout(poll,50);
      }; poll();
    });

    // Mobile niceties on load
    (async()=>{
      const app = await ready;
      // If on a narrow screen, hide sidebar and fit width
      if (matchMedia('(max-width: 900px)').matches){
        try { app.pdfSidebar.close(); } catch(_){}
        app.pdfViewer.currentScaleValue = 'page-width';
      }
    })();

    // Controls
    document.getElementById('fit').addEventListener('click', async()=>{
      (await ready).pdfViewer.currentScaleValue = 'page-width';
    });
    document.getElementById('thumbs').addEventListener('click', async()=>{
      const a = await ready; const s = a.pdfSidebar; s.isOpen ? s.close() : (s.open(), s.switchView(1));
    });

    // Mobile dock
    document.getElementById('mPrev').addEventListener('click', async()=>{
      const a = await ready; a.page = Math.max(1, a.page - 1);
    });
    document.getElementById('mNext').addEventListener('click', async()=>{
      const a = await ready; a.page = Math.min(a.pagesCount, a.page + 1);
    });
    document.getElementById('mDl').addEventListener('click', async()=>{
      await ready; frame.contentDocument.getElementById('download').click();
    });

    // File open (works offline)
    document.getElementById('file').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const url = URL.createObjectURL(f);
      frame.src = `/web/viewer.html?file=${encodeURIComponent(url)}#zoom=page-width`;
    });

    // iOS Safari: keep 100dvh on rotate
    addEventListener('orientationchange', ()=>{ document.documentElement.style.height = '100dvh'; });
  </script>
  
  <!-- Signature Modal (app shell overlay; PDF.js remains untouched) -->
  <div id="sigModal" class="modal" aria-hidden="true" role="dialog" aria-label="Signature">
    <div class="sheet" role="document">
      <header>
        <h3>Create / Manage Signatures</h3>
        <div style="flex:1"></div>
        <button id="closeSig" class="btn" aria-label="Close">Close</button>
      </header>
      <main>
        <div class="sig-row">
          <div>
            <div class="pad"><canvas id="sigPad"></canvas></div>
            <div class="tools" style="margin-top:8px">
              <button id="penBlack" class="btn">Black</button>
              <button id="penBlue" class="btn">Blue</button>
              <button id="penThick" class="btn">Thicker</button>
              <button id="penThin" class="btn">Thinner</button>
              <button id="clearPad" class="btn danger">Clear</button>
            </div>
          </div>
          <div>
            <div class="tools" style="justify-content:space-between">
              <strong>Saved Signatures</strong>
              <div>
                <button id="saveSig" class="btn">Save</button>
                <button id="useSig" class="btn">Use Selected</button>
                <button id="deleteSig" class="btn danger">Delete</button>
              </div>
            </div>
            <div id="sigGallery" class="gallery" style="margin-top:8px"></div>
          </div>
        </div>
      </main>
      <footer>
        <div style="margin-right:auto;color:#aab2c0">Tip: draw on the left, select on the right, then “Use Selected” and click Place to position it.</div>
        <button id="closeSig2" class="btn">Done</button>
      </footer>
    </div>
  </div>

  <!-- libs for signing/export (no changes to PDF.js files) -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

  <script>
  /* ===== TurboSign signing layer (robust, mobile-friendly) ===== */
  (function(){
    const LS_KEY = 'ts_signatures_v1';
    let currentSignature = null;         // dataURL selected for placement
    let placeMode = false;               // if true, clicks place signatures
    let placements = [];                 // {id, pageNumber, leftPx, topPx, widthPx, heightPx, dataURL}

    const $ = (id)=>document.getElementById(id);

    // ----- Modal open/close -----
    const modal = $('sigModal');
    function openModal(){
      modal?.classList.add('open');
      modal?.setAttribute('aria-hidden','false');
      document.body.classList.add('modal-open');
      try { $('viewer').style.pointerEvents='none'; } catch {}
      resizePad(); renderGallery();
      if (!window.SignaturePad) alert('SignaturePad failed to load.');
    }
    function closeModal(){
      modal?.classList.remove('open');
      modal?.setAttribute('aria-hidden','true');
      document.body.classList.remove('modal-open');
      try { $('viewer').style.pointerEvents=''; } catch {}
    }

    // ----- Signature pad -----
    const padCanvas = $('sigPad');
    let penWidth = 2.5, penColor = '#111';
    let sigPad;
    function resizePad(){
      if (!padCanvas) return;
      const dpr = Math.max(window.devicePixelRatio||1, 1);
      const rect = padCanvas.getBoundingClientRect();
      if (!rect.width) return;
      padCanvas.width = rect.width * dpr;
      padCanvas.height = rect.height * dpr;
      const ctx = padCanvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      if (!sigPad) sigPad = new SignaturePad(padCanvas, { minWidth: penWidth, maxWidth: penWidth+0.8, penColor });
      else sigPad.clear(), (sigPad.minWidth=penWidth), (sigPad.maxWidth=penWidth+0.8), (sigPad.penColor=penColor);
      // keep white background
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,padCanvas.width, padCanvas.height);
    }
    if ('ResizeObserver' in window && padCanvas?.parentElement) new ResizeObserver(resizePad).observe(padCanvas.parentElement); else window.addEventListener('resize', resizePad);

    // ----- Gallery -----
    const gallery = $('sigGallery');
    const getSigs = ()=>{ try { return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); } catch { return []; } };
    const setSigs = (arr)=> localStorage.setItem(LS_KEY, JSON.stringify(arr));
    function renderGallery(){ if(!gallery) return; gallery.innerHTML=''; getSigs().forEach((dataURL, idx)=>{
      const d = document.createElement('div'); d.className='thumb'; d.dataset.idx=String(idx);
      const img = new Image(); img.src=dataURL; d.appendChild(img);
      const meta = document.createElement('div'); meta.style.cssText='display:flex;justify-content:space-between;font-size:12px;color:#aab2c0';
      meta.innerHTML = `<span>#${idx+1}</span><span>${Math.round(dataURL.length/1024)} KB</span>`; d.appendChild(meta);
      d.addEventListener('click', ()=>{ document.querySelectorAll('.thumb.selected').forEach(n=>n.classList.remove('selected')); d.classList.add('selected'); currentSignature = dataURL; });
      gallery.appendChild(d);
    }); }

    // ----- Place mode toggle -----
    function enablePlaceMode(on){
      placeMode = !!on; $('place')?.classList.toggle('active', placeMode); $('mPlace')?.classList.toggle('active', placeMode);
      if (placeMode && !currentSignature) openModal();
    }

    // ----- PDF.js app access -----
    const frame = $('viewer');
    function getApp(){ return new Promise(res=>{ const poll=()=>{ try{ const a=frame.contentWindow?.PDFViewerApplication; if(a?.initializedPromise) return a.initializedPromise.then(()=>res(a)); }catch{} setTimeout(poll,50); }; poll(); }); }

    // ----- Click in pages to place overlays -----
    (async ()=>{
      const app = await getApp(); const doc = frame.contentDocument; const container = doc.getElementById('viewer'); if (!container) return;
      container.addEventListener('click', (ev)=>{
        if (!placeMode || !currentSignature) return;
        const pageDiv = ev.target.closest('.page'); if (!pageDiv) return;
        const pageNum = +pageDiv.getAttribute('data-page-number');
        const rect = pageDiv.getBoundingClientRect(); const xPx = ev.clientX - rect.left; const yPx = ev.clientY - rect.top;
        const displayPx = Math.min( Math.max(rect.width*0.35, 160), 360 );

        // overlay wrapper
        pageDiv.style.position='relative';
        const wrap = document.createElement('div'); wrap.className='sig-overlay';
        const img = new Image(); img.src=currentSignature; img.alt='signature'; img.style.width=displayPx+'px'; wrap.appendChild(img);
        const del = document.createElement('div'); del.className='sig-del'; del.textContent='×'; wrap.appendChild(del);
        pageDiv.appendChild(wrap);

        // initial pos
        wrap.style.left = (xPx - displayPx/2) + 'px'; wrap.style.top = (yPx - displayPx*0.35) + 'px';

        // bounding + selection
        function clamp(){ const pr=pageDiv.getBoundingClientRect(); const br=wrap.getBoundingClientRect(); let l=parseFloat(wrap.style.left)||0, t=parseFloat(wrap.style.top)||0; const maxL=pr.width-br.width, maxT=pr.height-br.height; if(l<0)l=0; if(t<0)t=0; if(l>maxL)l=maxL; if(t>maxT)t=maxT; wrap.style.left=l+'px'; wrap.style.top=t+'px'; }
        clamp();
        wrap.addEventListener('pointerdown', ()=>{ document.querySelectorAll('.sig-overlay.selected').forEach(n=>n.classList.remove('selected')); wrap.classList.add('selected'); });
        del.addEventListener('click', (e)=>{ e.stopPropagation(); const idx=placements.findIndex(p=>p.id===id); if(idx>-1) placements.splice(idx,1); wrap.remove(); });

        // drag
        let dragging=false,sx=0,sy=0,bl=0,bt=0; wrap.addEventListener('pointerdown', (e)=>{ dragging=true; wrap.setPointerCapture(e.pointerId); sx=e.clientX; sy=e.clientY; bl=parseFloat(wrap.style.left)||0; bt=parseFloat(wrap.style.top)||0; });
        wrap.addEventListener('pointermove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; wrap.style.left=(bl+dx)+'px'; wrap.style.top=(bt+dy)+'px'; clamp(); updatePlacement(id); });
        wrap.addEventListener('pointerup', (e)=>{ dragging=false; try{ wrap.releasePointerCapture(e.pointerId);}catch{} clamp(); updatePlacement(id); });

        // record
        const id = Math.random().toString(36).slice(2,9);
        const br = wrap.getBoundingClientRect();
        placements.push({ id, pageNumber: pageNum, leftPx: parseFloat(wrap.style.left)||0, topPx: parseFloat(wrap.style.top)||0, widthPx: br.width, heightPx: br.height, dataURL: currentSignature });
        function updatePlacement(pid){ const p=placements.find(x=>x.id===pid); if(!p) return; const b=wrap.getBoundingClientRect(); p.leftPx=parseFloat(wrap.style.left)||0; p.topPx=parseFloat(wrap.style.top)||0; p.widthPx=b.width; p.heightPx=b.height; }
      }, {passive:true});
    })();

    // ----- Export (flatten overlays) -----
    async function doExport(){
      const app = await getApp(); if(!app?.pdfDocument){ alert('No PDF loaded.'); return; }
      const bytes = await app.pdfDocument.getData(); const pdfDoc = await PDFLib.PDFDocument.load(bytes);
      for (const p of placements) {
        const page = pdfDoc.getPage(p.pageNumber-1); const pageView = app.pdfViewer.getPageView(p.pageNumber-1); const vp = pageView.viewport;
        const widthPts = p.widthPx / vp.scale; const heightPts = p.heightPx / vp.scale;
        const centerXPts = (p.leftPx + p.widthPx/2) / vp.scale; const centerYPts = vp.height - ((p.topPx + p.heightPx/2) / vp.scale);
        const x = centerXPts - widthPts/2; const y = centerYPts - heightPts/2; const png = await pdfDoc.embedPng(p.dataURL);
        page.drawImage(png, { x, y, width: widthPts, height: heightPts });
      }
      const out = await pdfDoc.save(); const blob = new Blob([out],{type:'application/pdf'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='signed.pdf'; a.click();
    }

    // ----- Safe bindings (guarded + delegated) -----
    document.addEventListener('click', (ev)=>{
      const t = ev.target.closest?.('#sign,#closeSig,#closeSig2,#place,#mPlace,#export,.sig-del'); if(!t) return;
      if (t.id === 'sign') openModal();
      else if (t.id === 'closeSig' || t.id === 'closeSig2') closeModal();
      else if (t.id === 'place' || t.id === 'mPlace') enablePlaceMode(!placeMode);
      else if (t.id === 'export') doExport();
    });

    // ----- Toolbar helpers already present in wrapper -----
    // (Fit, Thumbs, Prev, Next, Download etc. remain unchanged)

    // ----- SignaturePad controls -----
    document.addEventListener('click', (ev)=>{
      const b = ev.target; if (!(b instanceof HTMLElement)) return;
      if (b.id==='penBlack'){ penColor='#111'; if(sigPad) sigPad.penColor=penColor; resizePad(); }
      if (b.id==='penBlue'){ penColor='#0d5bd6'; if(sigPad) sigPad.penColor=penColor; resizePad(); }
      if (b.id==='penThick'){ penWidth=Math.min(6,penWidth+0.8); if(sigPad){ sigPad.minWidth=penWidth; sigPad.maxWidth=penWidth+0.8; } }
      if (b.id==='penThin'){ penWidth=Math.max(1,penWidth-0.8); if(sigPad){ sigPad.minWidth=penWidth; sigPad.maxWidth=penWidth+0.8; } }
      if (b.id==='clearPad'){ sigPad?.clear(); resizePad(); }
      if (b.id==='saveSig'){
        if (!sigPad || sigPad.isEmpty()) return alert('Draw a signature first.');
        const dataURL = sigPad.toDataURL('image/png'); const sigs = getSigs(); sigs.push(dataURL); setSigs(sigs); renderGallery();
      }
      if (b.id==='useSig'){
        if (!currentSignature) return alert('Select a saved signature on the right.');
        closeModal(); enablePlaceMode(true);
      }
      if (b.id==='deleteSig'){
        const sel = document.querySelector('.thumb.selected'); if (!sel) return alert('Select a signature to delete.');
        const idx = +sel.dataset.idx; const sigs=getSigs(); sigs.splice(idx,1); setSigs(sigs); currentSignature=null; renderGallery();
      }
    });

    // Delete selected overlay with Delete/Backspace
    addEventListener('keydown', (e)=>{
      if(e.key!=='Delete' && e.key!=='Backspace') return;
      const doc = frame.contentDocument || document; const sel = doc.querySelector('.sig-overlay.selected'); if(!sel) return;
      const pageDiv = sel.closest('.page'); const pageNum = pageDiv? +pageDiv.getAttribute('data-page-number') : null;
      const l = parseFloat(sel.style.left||'0'); const t = parseFloat(sel.style.top||'0'); const w = sel.getBoundingClientRect().width;
      const idx = placements.findIndex(p => p.pageNumber===pageNum && Math.abs(p.leftPx-l)<2 && Math.abs(p.topPx-t)<2 && Math.abs(p.widthPx-w)<2);
      if(idx>-1) placements.splice(idx,1); sel.remove();
    });

  })();
  </script>
</body>
</html>
